(function(){var a=Backbone.Form,b=a.editors.Base,c=a.helpers.createTemplate,d=a.helpers.triggerCancellableEvent,e={};e.Date=b.extend({className:"bbf-date",initialize:function(a){b.prototype.initialize.call(this,a),this.value&&!_.isDate(this.value)&&(this.value=new Date(this.value));if(!this.value){var c=new Date;c.setSeconds(0),c.setMilliseconds(0),this.value=c}},render:function(){var a=this.$el;a.html("<input>");var b=$("input",a);return b.datepicker({dateFormat:"dd/mm/yy",showButtonPanel:!0}),e.Date.prototype.setValue.call(this,this.value),this},getValue:function(){var a=$("input",this.el),b=a.datepicker("getDate");return b},setValue:function(a){$("input",this.el).datepicker("setDate",a)}}),e.DateTime=e.Date.extend({className:"bbf-datetime",template:c("<select>{{hours}}</select> : <select>{{mins}}</select>"),render:function(){function a(a){return a<10?"0"+a:a}e.Date.prototype.render.call(this);var b=_.range(0,24),c=[];_.each(b,function(b){c.push('<option value="'+b+'">'+a(b)+"</option>")});var d=this.schema.minsInterval||15,f=_.range(0,60,d),g=[];return _.each(f,function(b){g.push('<option value="'+b+'">'+a(b)+"</option>")}),this.$el.append(this.template({hours:c.join(),mins:g.join()})),this.$hours=$("select:eq(0)",this.el),this.$mins=$("select:eq(1)",this.el),this.setValue(this.value),this},getValue:function(){var a=$("input",this.el),b=a.datepicker("getDate");return b.setHours(this.$hours.val()),b.setMinutes(this.$mins.val()),b.setMilliseconds(0),b},setValue:function(a){e.Date.prototype.setValue.call(this,a),this.$hours.val(a.getHours()),this.$mins.val(a.getMinutes())}}),e.List=b.extend({className:"bbf-list",template:c('      <ul></ul>      <div><button class="bbf-list-add">Add</div>    '),itemTemplate:c('      <li rel="{{id}}">        <span class="bbf-list-text">{{text}}</span>        <div class="bbf-list-actions">          <button class="bbf-list-edit">Edit</button>          <button class="bbf-list-del">Delete</button>        </div>      </li>    '),editorTemplate:c('      <div class="bbf-field">          <div class="bbf-list-editor"></div>      </div>    '),events:{"click .bbf-list-add":"addNewItem","click .bbf-list-edit":"editItem","click .bbf-list-del":"deleteItem"},initialize:function(a){b.prototype.initialize.call(this,a);if(!this.schema)throw"Missing required option 'schema'";this.schema.listType=this.schema.listType||"Text";if(this.schema.listType=="NestedModel"&&!this.schema.model)throw"Missing required option 'schema.model'"},render:function(){var a=this.$el;a.html(this.template());var b=this,c=this.value||[],d=this.schema,e=this.itemToString,f=this.itemTemplate,g=$("ul",a);return _.each(c,function(a){var c=e.call(b,a),d=$(f({id:a.id||"",text:c}));$.data(d[0],"data",a),g.append(d)}),d.sortable!==!1&&(g.sortable({axis:"y",cursor:"move",containment:"parent"}),a.addClass("bbf-list-sortable")),$("button.bbf-list-add",a).button({text:!1,icons:{primary:"ui-icon-plus"}}),$("button.bbf-list-edit",a).button({text:!1,icons:{primary:"ui-icon-pencil"}}),$("button.bbf-list-del",a).button({text:!1,icons:{primary:"ui-icon-trash"}}),this},itemToString:function(a){if(!a)return a;var b=this.schema;if(b.itemToString)return b.itemToString(a);if(this.schema.listType=="NestedModel"){var c=new this.schema.model(a);return c.toString()}return a},addNewItem:function(a){a.preventDefault();var b=this;this.openEditor(null,function(a){d(b,"addItem",[a],function(){var c=b.itemToString(a),d=$(b.itemTemplate({id:a.id||"",text:c}));$.data(d[0],"data",a),$("ul",b.el).append(d),$("button.bbf-list-edit",this.el).button({text:!1,icons:{primary:"ui-icon-pencil"}}),$("button.bbf-list-del",this.el).button({text:!1,icons:{primary:"ui-icon-trash"}})})})},editItem:function(a){a.preventDefault();var b=this,c=$(a.target).closest("li"),e=$.data(c[0],"data");this.openEditor(e,function(a){d(b,"editItem",[a],function(){$(".bbf-list-text",c).html(b.itemToString(a)),$.data(c[0],"data",a)})})},deleteItem:function(a){function h(){d(b,"removeItem",[e],function(){c.remove()})}a.preventDefault();var b=this,c=$(a.target).closest("li"),e=$.data(c[0],"data"),f=this.schema.confirmDelete?this.schema.confirmDelete:!1,g=this.schema.confirmDeleteMsg||"Are you sure?";this.schema.confirmDelete?confirm(g)&&h():h()},openEditor:function(b,c){var d=this,e=this.schema,f=e.listType||"Text",g=a.helpers.createEditor(f,{key:"",schema:e,value:b}).render(),h=$(this.editorTemplate());$(".bbf-list-editor",h).html(g.el);var i=function(){$(document).unbind("keydown",k),h.dialog("close"),g.remove(),h.remove()},j=function(){var a=g.validate();if(a)return;c(g.getValue()),i()},k=function(a){if(a.keyCode!=13)return;j()};$(h).dialog({resizable:!1,modal:!0,width:500,title:b?"Edit item":"New item",buttons:{OK:j,Cancel:i}}),$(document).bind("keydown",k)},getValue:function(){var a=[];return $("li",this.el).each(function(b,c){a.push($.data(c,"data"))}),a},setValue:function(a){this.value=a,this.render()}}),_.extend(a.editors,e)})()